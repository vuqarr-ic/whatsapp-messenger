#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è STORK –Ω–∞ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º —Ö–æ—Å—Ç–∏–Ω–≥–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy.sh

echo "üöÄ –ù–∞—á–∞–ª–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è STORK..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js
if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs
fi

echo "‚úÖ Node.js —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(node --version)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ PM2
if ! command -v pm2 &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é PM2..."
    npm install -g pm2
fi

echo "‚úÖ PM2 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm install

# –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
echo "üî® –°–æ–±–∏—Ä–∞—é —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥..."
npm run build

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
pm2 stop stork-signaling 2>/dev/null
pm2 delete stork-signaling 2>/dev/null

# –ó–∞–ø—É—Å–∫ signaling —Å–µ—Ä–≤–µ—Ä–∞
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é signaling —Å–µ—Ä–≤–µ—Ä..."
cd server
pm2 start index.js --name stork-signaling
pm2 save

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
pm2 startup | tail -1 | bash

echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üìä –°—Ç–∞—Ç—É—Å:"
pm2 status

echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Nginx (—Å–º. –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï_–ù–ê_–†–û–°–°–ò–ô–°–ö–û–ú_–•–û–°–¢–ò–ù–ì–ï.md)"
echo "2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–æ–º–µ–Ω"
echo "3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ SSL: certbot --nginx -d –≤–∞—à-–¥–æ–º–µ–Ω.ru"
echo ""
echo "–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: pm2 logs stork-signaling"
